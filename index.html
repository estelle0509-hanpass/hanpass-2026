<!DOCTYPE html>
<!--
  HanPass 2026 Dashboard
  Version: 4.2.0
  Updated: 2026-02-02
  
  Features:
  - Hybrid matching: KPI Relations + project.kpi field
  - All 5 viral projects displayed
  - Mobile: Snap scroll + arrows + counter + infinite loop
  - PC: Fixed column widths
-->
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HanPass 2026 Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
    }

    .sync-info {
      font-size: 13px;
      opacity: 0.9;
    }

    .controls {
      display: flex;
      gap: 10px;
      padding: 20px 30px;
      border-bottom: 1px solid #e0e0e0;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    .content {
      padding: 30px;
    }

    .kpi-group {
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }

    .kpi-header {
      background: #f8f9fa;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    .kpi-header:hover {
      background: #e9ecef;
    }

    .kpi-header h2 {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .count {
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .kpi-content {
      display: none;
    }

    .kpi-content.active {
      display: block;
    }

    .detail-group {
      border-top: 1px solid #e0e0e0;
    }

    .detail-header {
      background: #fafafa;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .detail-header:hover {
      background: #f0f0f0;
    }

    .detail-header h3 {
      font-size: 15px;
      font-weight: 500;
      color: #555;
    }

    .detail-content {
      display: none;
    }

    .detail-content.active {
      display: block;
    }

    /* PC ÌÖåÏù¥Î∏î */
    .project-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .project-table thead {
      background: #f8f9fa;
    }

    .project-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      color: #666;
      border-bottom: 2px solid #e0e0e0;
    }

    .project-table th:nth-child(1) { width: 20%; }
    .project-table th:nth-child(2) { width: 15%; }
    .project-table th:nth-child(3) { width: 10%; }
    .project-table th:nth-child(4) { width: 12%; }
    .project-table th:nth-child(5) { width: 12%; }
    .project-table th:nth-child(6) { width: 10%; }
    .project-table th:nth-child(7) { width: 10%; }
    .project-table th:nth-child(8) { width: 11%; }

    .project-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .project-table tr:hover {
      background: #f8f9fa;
    }

    .project-name {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
    }

    .project-name:hover {
      text-decoration: underline;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .progress-bar {
      width: 60px;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #667eea;
      transition: width 0.3s;
    }

    .error {
      padding: 20px;
      background: #fff3f3;
      border: 1px solid #ffcdd2;
      border-radius: 8px;
      color: #c62828;
      text-align: center;
    }

    .empty-state {
      padding: 40px;
      text-align: center;
      color: #999;
      font-size: 14px;
    }

    .mobile-scroll-wrapper {
      position: relative;
    }

    .scroll-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #667eea;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      font-size: 18px;
      color: #667eea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.2s;
    }

    .scroll-arrow:hover {
      background: #667eea;
      color: white;
    }

    .scroll-arrow.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .scroll-arrow.left {
      left: 10px;
    }

    .scroll-arrow.right {
      right: 10px;
    }

    .page-indicator {
      text-align: center;
      padding: 10px;
      font-size: 13px;
      color: #666;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      body { padding: 0; }
      .container { border-radius: 0; }
      .header { flex-direction: column; align-items: flex-start; padding: 20px; }
      .header h1 { font-size: 22px; }
      .controls { padding: 15px; }
      .content { padding: 15px; }

      .project-table thead { display: none; }
      .project-table tbody {
        display: flex;
        overflow-x: auto;
        gap: 15px;
        scroll-snap-type: x mandatory;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        padding: 0 10px;
      }
      .project-table tbody::-webkit-scrollbar { display: none; }
      .project-table tr {
        display: block;
        min-width: 280px;
        max-width: 280px;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        scroll-snap-align: center;
        flex-shrink: 0;
      }
      .project-table td {
        display: block;
        padding: 6px 0;
        border: none;
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
      }
      .project-table td:before {
        content: attr(data-label);
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
        color: #666;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>üöÄ HanPass 2026 Dashboard</h1>
        <div class="sync-info" id="sync-info">NotionÍ≥º ÎèôÍ∏∞Ìôî Ï§ë...</div>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" onclick="expandAll()">üîÑ Ï†ÑÏ≤¥ Ïó¥Í∏∞</button>
      <button class="btn btn-secondary" onclick="collapseAll()">üìÅ Ï†ÑÏ≤¥ Îã´Í∏∞</button>
      <button class="btn btn-secondary" onclick="loadData()">üîÉ ÏÉàÎ°úÍ≥†Ïπ®</button>
    </div>

    <div class="content" id="dashboard">
      ‚è≥ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
    </div>
  </div>

  <script>
    const API_URL = 'https://hanpass-2026-backend.vercel.app/api/index';
    let allData = null;

    async function loadData() {
      try {
        const response = await fetch(`${API_URL}?type=all&v=4.2.0&_t=${Date.now()}`, {
          cache: 'no-store',
          headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const result = await response.json();
        if (!result.success) throw new Error(result.error || 'API error');

        allData = result.data;
        renderDashboard();
        updateSyncInfo();
        setTimeout(initMobileScrollTracking, 300);
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('dashboard').innerHTML = `
          <div class="error">‚ö†Ô∏è ${error.message}</div>
        `;
      }
    }

    function renderDashboard() {
      if (!allData) return;

      const { kpis, projects } = allData;
      console.log('üîç KPIs:', kpis.length, 'Projects:', projects.length);

      const grouped = {};
      const assignedProjects = new Set();

      // 1. Î™®Îì† KPI Ï¥àÍ∏∞Ìôî
      kpis.forEach(kpi => {
        grouped[kpi.id] = { kpi: kpi, details: {} };
      });

      // 2. KPI Relations Ïö∞ÏÑ† Îß§Ïπ≠
      kpis.forEach(kpi => {
        if (kpi.projects && kpi.projects.length > 0) {
          kpi.projects.forEach(projRef => {
            const project = projects.find(p => p.id === projRef.id);
            if (project) {
              const detailName = project.kpiDetail || 'ÎØ∏Î∂ÑÎ•ò';
              if (!grouped[kpi.id].details[detailName]) {
                grouped[kpi.id].details[detailName] = [];
              }
              grouped[kpi.id].details[detailName].push(project);
              assignedProjects.add(project.id);
            }
          });
        }
      });

      // 3. Fallback: project.kpi ÌïÑÎìúÎ°ú Îß§Ïπ≠ (RelationsÏóê ÏóÜÎäî ÌîÑÎ°úÏ†ùÌä∏)
      projects.forEach(project => {
        if (assignedProjects.has(project.id)) return; // Ïù¥ÎØ∏ Ìï†ÎãπÎê®

        if (project.kpi) {
          const kpi = kpis.find(k => k.id === project.kpi);
          if (kpi) {
            const detailName = project.kpiDetail || 'ÎØ∏Î∂ÑÎ•ò';
            if (!grouped[kpi.id].details[detailName]) {
              grouped[kpi.id].details[detailName] = [];
            }
            grouped[kpi.id].details[detailName].push(project);
            assignedProjects.add(project.id);
            console.log(`‚úÖ Fallback matched: ${project.name} ‚Üí ${kpi.name}`);
          }
        }
      });

      // 4. ÎØ∏Î∂ÑÎ•ò (Ïñ¥ÎîîÏóêÎèÑ ÏÜçÌïòÏßÄ ÏïäÎäî ÌîÑÎ°úÏ†ùÌä∏)
      projects.forEach(project => {
        if (!assignedProjects.has(project.id)) {
          const kpiId = 'ÎØ∏Î∂ÑÎ•ò';
          if (!grouped[kpiId]) {
            grouped[kpiId] = {
              kpi: { id: kpiId, name: 'ÎØ∏Î∂ÑÎ•ò', count: 0 },
              details: {}
            };
          }
          const detailName = project.kpiDetail || 'ÎØ∏Î∂ÑÎ•ò';
          if (!grouped[kpiId].details[detailName]) {
            grouped[kpiId].details[detailName] = [];
          }
          grouped[kpiId].details[detailName].push(project);
        }
      });

      // 5. KPI Ï†ïÎ†¨
      const sortedKpiIds = Object.keys(grouped).sort((a, b) => {
        const nameA = grouped[a].kpi.name;
        const nameB = grouped[b].kpi.name;
        const getPriority = (name) => {
          const fc = name.charAt(0);
          if (/\d/.test(fc)) return 1;
          if (/[A-Za-z]/.test(fc)) return 2;
          return 3;
        };
        const pA = getPriority(nameA), pB = getPriority(nameB);
        if (pA !== pB) return pA - pB;
        return pA === 2 ? nameA.localeCompare(nameB, 'en', {numeric: true}) : nameA.localeCompare(nameB, 'ko', {numeric: true});
      });

      // 6. HTML ÏÉùÏÑ±
      let html = '';
      sortedKpiIds.forEach(kpiId => {
        const group = grouped[kpiId];
        const kpi = group.kpi;
        const totalProjects = Object.values(group.details).reduce((sum, arr) => sum + arr.length, 0);

        html += `
          <div class="kpi-group">
            <div class="kpi-header" onclick="toggleKpi('${kpiId}')">
              <h2>${kpi.name}</h2>
              <span class="count">${totalProjects}Í∞ú</span>
            </div>
            <div class="kpi-content" id="kpi-${kpiId}">
        `;

        if (totalProjects === 0) {
          html += `<div class="empty-state">ÏïÑÏßÅ Îì±Î°ùÎêú ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.</div>`;
        } else {
          const sortedDetails = Object.keys(group.details).sort();
          sortedDetails.forEach(detailName => {
            const detailProjects = group.details[detailName];
            detailProjects.sort((a, b) => a.name.localeCompare(b.name, 'ko'));

            html += `
              <div class="detail-group">
                <div class="detail-header" onclick="toggleDetail('${kpiId}-${detailName}')">
                  <h3>üìç ${detailName}</h3>
                  <span class="count">${detailProjects.length}Í∞ú</span>
                </div>
                <div class="detail-content" id="detail-${kpiId}-${detailName}">
                  <div class="mobile-scroll-wrapper">
                    <div class="scroll-arrow left hidden" onclick="scrollMobile(this, -1)">‚Äπ</div>
                    <div class="scroll-arrow right" onclick="scrollMobile(this, 1)">‚Ä∫</div>
                    <table class="project-table">
                      <thead>
                        <tr>
                          <th>ÌîÑÎ°úÏ†ùÌä∏Î™Ö</th><th>Î™©Ìëú</th><th>Íµ≠Í∞Ä</th><th>Î∂ÄÏÑú</th>
                          <th>Îã¥ÎãπÏûê</th><th>ÏÉÅÌÉú</th><th>ÏßÑÌñâÎ•†</th><th>ÎßàÍ∞êÏùº</th>
                        </tr>
                      </thead>
                      <tbody class="mobile-scroll-container">
            `;

            detailProjects.forEach(p => {
              html += `
                <tr>
                  <td data-label="ÌîÑÎ°úÏ†ùÌä∏Î™Ö"><a href="${p.link}" target="_blank" class="project-name">${p.name}</a></td>
                  <td data-label="Î™©Ìëú">${p.goal || '-'}</td>
                  <td data-label="Íµ≠Í∞Ä">${p.country || '-'}</td>
                  <td data-label="Î∂ÄÏÑú">${p.division || '-'}</td>
                  <td data-label="Îã¥ÎãπÏûê">${p.owner || '-'}</td>
                  <td data-label="ÏÉÅÌÉú"><span class="status-badge">${p.status || '-'}</span></td>
                  <td data-label="ÏßÑÌñâÎ•†"><div class="progress-bar"><div class="progress-fill" style="width:${p.progress||0}%"></div></div></td>
                  <td data-label="ÎßàÍ∞êÏùº">${p.deadline || '-'}</td>
                </tr>
              `;
            });

            html += `</tbody></table><div class="page-indicator"></div></div></div></div>`;
          });
        }
        html += `</div></div>`;
      });

      document.getElementById('dashboard').innerHTML = html;
    }

    function toggleKpi(id) { document.getElementById(`kpi-${id}`)?.classList.toggle('active'); }
    function toggleDetail(id) { document.getElementById(`detail-${id}`)?.classList.toggle('active'); }
    function expandAll() { document.querySelectorAll('.kpi-content, .detail-content').forEach(el => el.classList.add('active')); }
    function collapseAll() { document.querySelectorAll('.kpi-content, .detail-content').forEach(el => el.classList.remove('active')); }
    function updateSyncInfo() { document.getElementById('sync-info').textContent = `ÎßàÏßÄÎßâ ÎèôÍ∏∞Ìôî: ${new Date().toLocaleString('ko-KR')}`; }

    function initMobileScrollTracking() {
      if (window.innerWidth > 768) return;
      document.querySelectorAll('.mobile-scroll-container').forEach(tbody => {
        const wrapper = tbody.closest('.mobile-scroll-wrapper');
        const leftArrow = wrapper.querySelector('.scroll-arrow.left');
        const rightArrow = wrapper.querySelector('.scroll-arrow.right');
        const indicator = wrapper.querySelector('.page-indicator');
        const cards = tbody.querySelectorAll('tr');
        if (cards.length === 0) return;

        function updateUI() {
          const sl = tbody.scrollLeft, cw = cards[0].offsetWidth, gap = 15;
          const idx = Math.round(sl / (cw + gap));
          indicator.textContent = `${idx + 1} / ${cards.length}`;
          leftArrow.classList.toggle('hidden', idx === 0);
          rightArrow.textContent = idx >= cards.length - 1 ? '‚ü≤' : '‚Ä∫';
        }

        tbody.addEventListener('scroll', updateUI);

        let touchStartX = 0;
        tbody.addEventListener('touchstart', e => touchStartX = e.touches[0].clientX);
        tbody.addEventListener('touchend', e => {
          const diff = touchStartX - e.changedTouches[0].clientX;
          if (Math.abs(diff) > 50 && diff > 0 && tbody.scrollLeft >= tbody.scrollWidth - tbody.clientWidth - 5) {
            tbody.scrollTo({ left: 0, behavior: 'smooth' });
          }
        });

        updateUI();
      });
    }

    function scrollMobile(arrow, dir) {
      const wrapper = arrow.closest('.mobile-scroll-wrapper');
      const tbody = wrapper.querySelector('.mobile-scroll-container');
      const cards = tbody.querySelectorAll('tr');
      const cw = cards[0].offsetWidth, gap = 15;
      const maxScroll = tbody.scrollWidth - tbody.clientWidth;
      if (dir === 1 && tbody.scrollLeft >= maxScroll - 5) {
        tbody.scrollTo({ left: 0, behavior: 'smooth' });
      } else {
        tbody.scrollBy({ left: dir * (cw + gap), behavior: 'smooth' });
      }
    }

    loadData();
    window.addEventListener('resize', () => setTimeout(initMobileScrollTracking, 300));
  </script>
</body>
</html>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        