<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œíŒ¨ìŠ¤ 2026 ê²½ì˜ê¸°íš ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 14px;
        }

        /* í•„í„° ë° ì •ë ¬ ì»¨íŠ¸ë¡¤ */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .controls-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 12px;
            color: #7f8c8d;
            font-weight: 600;
        }

        .control-group select,
        .control-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .control-group input[type="text"] {
            width: 250px;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 18px;
        }

        .refresh-btn:hover {
            background: #5568d3;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .kpi-section {
            margin-bottom: 30px;
        }

        .kpi-group {
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid #f0f0f0;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .kpi-header:hover {
            background: #f8f9fa;
        }

        .kpi-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .kpi-header h2 {
            font-size: 20px;
            color: #2c3e50;
        }

        .collapse-icon {
            font-size: 18px;
            transition: transform 0.3s;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .kpi-header .count {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .projects-grid {
            padding: 20px;
            display: grid;
            gap: 12px;
            max-height: 2000px;
            opacity: 1;
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
        }

        .projects-grid.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0 20px;
            overflow: hidden;
        }

        .project-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 6px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .project-card:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: #f0f2f5;
        }

        .project-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .project-name::after {
            content: 'ğŸ”—';
            font-size: 12px;
            opacity: 0.5;
        }

        .project-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 13px;
            color: #7f8c8d;
        }

        .project-details div {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status.ì§„í–‰ì¤‘ {
            background: #3498db;
            color: white;
        }

        .status.ì™„ë£Œ {
            background: #2ecc71;
            color: white;
        }

        .status.ì‹œì‘ì „ {
            background: #95a5a6;
            color: white;
        }

        .status.ë°±ë¡œê·¸ {
            background: #e74c3c;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(3, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            background: white;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group input[type="text"] {
                width: 100%;
            }

            .project-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¯ í•œíŒ¨ìŠ¤ 2026 ê²½ì˜ê¸°íš ëŒ€ì‹œë³´ë“œ</h1>
            <p>Notion ë°ì´í„° ì‹¤ì‹œê°„ ì—°ë™ | ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">-</span></p>
        </header>

        <!-- í•„í„° ë° ì •ë ¬ ì»¨íŠ¸ë¡¤ -->
        <div class="controls">
            <div class="controls-row">
                <div class="control-group">
                    <label>ğŸ” ê²€ìƒ‰</label>
                    <input type="text" id="searchInput" placeholder="í”„ë¡œì íŠ¸ëª…ìœ¼ë¡œ ê²€ìƒ‰...">
                </div>

                <div class="control-group">
                    <label>ğŸ“Š KPI í•„í„°</label>
                    <select id="kpiFilter">
                        <option value="">ì „ì²´ KPI</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>ğŸ·ï¸ ìƒíƒœ í•„í„°</label>
                    <select id="statusFilter">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                        <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                        <option value="ì‹œì‘ì „">ì‹œì‘ì „</option>
                        <option value="ë°±ë¡œê·¸">ë°±ë¡œê·¸</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>ğŸ¢ ë¶€ë¬¸ í•„í„°</label>
                    <select id="divisionFilter">
                        <option value="">ì „ì²´ ë¶€ë¬¸</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>ğŸ“‘ ì •ë ¬</label>
                    <select id="sortBy">
                        <option value="name">ì´ë¦„ìˆœ</option>
                        <option value="status">ìƒíƒœìˆœ</option>
                        <option value="progress">ì§„í–‰ë¥ ìˆœ</option>
                        <option value="deadline">ë§ˆê°ì¼ìˆœ</option>
                        <option value="owner">ë‹´ë‹¹ììˆœ</option>
                    </select>
                </div>

                <button class="refresh-btn" onclick="loadData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>

        <div id="stats" class="stats"></div>
        <div id="content" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>
    </div>

    <script>
        const API_URL = 'https://hanpass-2026-backend.vercel.app/api?type=all';
        let allProjects = [];
        let allKpis = [];
        let collapsedGroups = new Set();

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('kpiFilter').addEventListener('change', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('divisionFilter').addEventListener('change', applyFilters);
        document.getElementById('sortBy').addEventListener('change', applyFilters);

        async function loadData() {
            try {
                document.getElementById('content').innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>';
                
                const response = await fetch(API_URL);
                const result = await response.json();

                if (!result.success) {
                    throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                }

                allKpis = result.data.kpis;
                allProjects = result.data.projects;
                
                // ì—…ë°ì´íŠ¸ ì‹œê°„
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ko-KR');

                // í•„í„° ì˜µì…˜ ì´ˆê¸°í™”
                initializeFilters();

                // í†µê³„ í‘œì‹œ
                displayStats(allKpis, allProjects);

                // í”„ë¡œì íŠ¸ í‘œì‹œ
                applyFilters();

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <strong>âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</strong><br>
                        ${error.message}<br>
                        <button class="refresh-btn" onclick="loadData()">ë‹¤ì‹œ ì‹œë„</button>
                    </div>
                `;
            }
        }

        function initializeFilters() {
            // KPI í•„í„° ì˜µì…˜
            const kpiFilter = document.getElementById('kpiFilter');
            kpiFilter.innerHTML = '<option value="">ì „ì²´ KPI</option>';
            allKpis.forEach(kpi => {
                const option = document.createElement('option');
                option.value = kpi.name;
                option.textContent = kpi.name;
                kpiFilter.appendChild(option);
            });

            // ë¶€ë¬¸ í•„í„° ì˜µì…˜
            const divisions = [...new Set(allProjects.map(p => p.division).filter(Boolean))];
            const divisionFilter = document.getElementById('divisionFilter');
            divisionFilter.innerHTML = '<option value="">ì „ì²´ ë¶€ë¬¸</option>';
            divisions.forEach(division => {
                const option = document.createElement('option');
                option.value = division;
                option.textContent = division;
                divisionFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const kpiFilter = document.getElementById('kpiFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const divisionFilter = document.getElementById('divisionFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            // í•„í„°ë§
            let filtered = allProjects.filter(project => {
                const matchesSearch = !searchTerm || 
                    (project.name && project.name.toLowerCase().includes(searchTerm)) ||
                    (project.code && project.code.toLowerCase().includes(searchTerm));
                
                const matchesKpi = !kpiFilter || project.kpi === kpiFilter;
                const matchesStatus = !statusFilter || project.status === statusFilter;
                const matchesDivision = !divisionFilter || project.division === divisionFilter;

                return matchesSearch && matchesKpi && matchesStatus && matchesDivision;
            });

            // ì •ë ¬
            filtered = sortProjects(filtered, sortBy);

            // í‘œì‹œ
            displayProjects(filtered);
        }

        function sortProjects(projects, sortBy) {
            return [...projects].sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        return (a.name || '').localeCompare(b.name || '');
                    case 'status':
                        const statusOrder = {'ì™„ë£Œ': 0, 'ì§„í–‰ì¤‘': 1, 'ì‹œì‘ì „': 2, 'ë°±ë¡œê·¸': 3};
                        return (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99);
                    case 'progress':
                        return (b.progress || 0) - (a.progress || 0);
                    case 'deadline':
                        if (!a.deadline && !b.deadline) return 0;
                        if (!a.deadline) return 1;
                        if (!b.deadline) return -1;
                        return new Date(a.deadline) - new Date(b.deadline);
                    case 'owner':
                        return (a.owner || '').localeCompare(b.owner || '');
                    default:
                        return 0;
                }
            });
        }

        function displayStats(kpis, projects) {
            const statusCount = {
                'ì§„í–‰ì¤‘': 0,
                'ì™„ë£Œ': 0,
                'ì‹œì‘ì „': 0,
                'ë°±ë¡œê·¸': 0
            };

            projects.forEach(p => {
                if (statusCount[p.status] !== undefined) {
                    statusCount[p.status]++;
                }
            });

            const statsHTML = `
                <div class="stat-card">
                    <h3>ì´ KPI</h3>
                    <div class="number">${kpis.length}</div>
                </div>
                <div class="stat-card">
                    <h3>ì´ í”„ë¡œì íŠ¸</h3>
                    <div class="number">${projects.length}</div>
                </div>
                <div class="stat-card">
                    <h3>ì§„í–‰ì¤‘</h3>
                    <div class="number" style="color: #3498db;">${statusCount['ì§„í–‰ì¤‘']}</div>
                </div>
                <div class="stat-card">
                    <h3>ì™„ë£Œ</h3>
                    <div class="number" style="color: #2ecc71;">${statusCount['ì™„ë£Œ']}</div>
                </div>
                <div class="stat-card">
                    <h3>ì‹œì‘ì „</h3>
                    <div class="number" style="color: #95a5a6;">${statusCount['ì‹œì‘ì „']}</div>
                </div>
                <div class="stat-card">
                    <h3>ë°±ë¡œê·¸</h3>
                    <div class="number" style="color: #e74c3c;">${statusCount['ë°±ë¡œê·¸']}</div>
                </div>
            `;

            document.getElementById('stats').innerHTML = statsHTML;
        }

        function displayProjects(projects) {
            if (projects.length === 0) {
                document.getElementById('content').innerHTML = `
                    <div class="no-results">
                        <h3>ğŸ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }

            // KPIë³„ ê·¸ë£¹í™”
            const groupedProjects = {};
            allKpis.forEach(kpi => {
                groupedProjects[kpi.name] = {
                    count: kpi.count,
                    projects: projects.filter(p => p.kpi === kpi.name)
                };
            });

            let html = '<div class="kpi-section">';

            for (const [kpiName, data] of Object.entries(groupedProjects)) {
                if (data.projects.length === 0) continue;

                const isCollapsed = collapsedGroups.has(kpiName);

                html += `
                    <div class="kpi-group">
                        <div class="kpi-header" onclick="toggleKpiGroup('${kpiName}')">
                            <div class="kpi-header-left">
                                <span class="collapse-icon ${isCollapsed ? 'collapsed' : ''}">â–¼</span>
                                <h2>ğŸ“Š ${kpiName}</h2>
                            </div>
                            <span class="count">${data.projects.length}ê°œ í”„ë¡œì íŠ¸</span>
                        </div>
                        <div class="projects-grid ${isCollapsed ? 'collapsed' : ''}" id="group-${kpiName}">
                `;

                data.projects.forEach(project => {
                    html += `
                        <div class="project-card" onclick="openNotionPage('${project.id}')">
                            <div class="project-name">${project.name || 'ì œëª© ì—†ìŒ'}</div>
                            <div class="project-details">
                                <div>ğŸ“Œ ì½”ë“œ: ${project.code || '-'}</div>
                                <div>ğŸ‘¤ ë‹´ë‹¹: ${project.owner || '-'}</div>
                                <div>ğŸ¢ ë¶€ë¬¸: ${project.division || '-'}</div>
                                <div><span class="status ${project.status || ''}">${project.status || '-'}</span></div>
                                ${project.deadline ? `<div>ğŸ“… ë§ˆê°: ${project.deadline}</div>` : ''}
                            </div>
                            ${project.progress !== null && project.progress !== undefined ? `
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${project.progress}%"></div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            document.getElementById('content').innerHTML = html;
        }

        function toggleKpiGroup(kpiName) {
            const group = document.getElementById(`group-${kpiName}`);
            const icon = event.currentTarget.querySelector('.collapse-icon');
            
            if (collapsedGroups.has(kpiName)) {
                collapsedGroups.delete(kpiName);
                group.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                collapsedGroups.add(kpiName);
                group.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        }

        function openNotionPage(projectId) {
            // Notion í˜ì´ì§€ URL ìƒì„±
            const notionUrl = `https://www.notion.so/${projectId.replace(/-/g, '')}`;
            window.open(notionUrl, '_blank');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        loadData();

        // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>
