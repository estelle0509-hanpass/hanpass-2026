<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HanPass 2026 Dashboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f5f7fa; color: #333; line-height: 1.6; overflow-x: hidden; }
.container { max-width: 1400px; margin: 0 auto; padding: 20px; }
header { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
header h1 { color: #2c3e50; font-size: 1.5em; }
.header-right { display: flex; gap: 10px; align-items: center; }
.btn { background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: background 0.2s; }
.btn:hover { background: #1976D2; }
.btn:active { background: #1565C0; }
.timestamp { color: #999; font-size: 0.85em; }
.vision-banner { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; padding: 15px; text-align: center; font-size: 1.1em; font-weight: 700; color: white; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
.tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e5e5e5; }
.tab { background: transparent; border: none; padding: 12px 24px; cursor: pointer; font-size: 1em; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; }
.tab.active { color: #2196F3; border-bottom-color: #2196F3; }
.tab:hover { color: #2196F3; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.pc-ui { display: block; }
.kpi-group { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.kpi-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s; }
.kpi-header:hover { background: #f8f9fa; }
.kpi-title { font-size: 1.3em; font-weight: 700; color: #2c3e50; }
.kpi-count { background: #2196F3; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: 600; margin-right: 10px; }
.kpi-arrow { font-size: 1.2em; color: #666; transition: transform 0.3s; display: inline-block; }
.kpi-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
.kpi-details.active { max-height: 10000px; transition: max-height 0.5s ease-in; }
.kpi-group:has(.kpi-details.active) .kpi-arrow { transform: rotate(180deg); }
.detail-section { margin-top: 15px; padding-top: 15px; border-top: 2px solid #f0f0f0; }
.detail-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
.detail-header:hover { background: #e9ecef; }
.detail-left { display: flex; align-items: center; gap: 10px; flex: 1; }
.detail-pin { font-size: 1.2em; }
.detail-title { font-size: 1.1em; font-weight: 600; color: #555; }
.detail-count { color: #2196F3; font-weight: 600; margin-right: 10px; }
.detail-arrow { font-size: 1.1em; color: #888; transition: transform 0.3s; display: inline-block; }
.detail-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
.detail-content.active { max-height: 5000px; transition: max-height 0.5s ease-in; }
.detail-section:has(.detail-content.active) .detail-arrow { transform: rotate(180deg); }
.table-container { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e5e5; }
th { background: #f8f9fa; color: #555; font-weight: 600; font-size: 0.9em; white-space: nowrap; }
td { font-size: 0.9em; color: #666; }
.project-link { color: #2196F3; text-decoration: none; font-weight: 600; transition: color 0.2s; }
.project-link:hover { color: #1976D2; text-decoration: underline; }
.edit-icon { cursor: pointer; font-size: 1.2em; color: #2196F3; transition: color 0.2s; }
.edit-icon:hover { color: #1976D2; }
.mobile-ui { display: none; }
.mobile-header { position: sticky; top: 0; background: white; z-index: 100; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 0 0 12px 12px; margin-bottom: 15px; }
.mobile-breadcrumb { font-size: 0.9em; color: #666; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
.mobile-level-label { background: #e3f2fd; color: #1976d2; padding: 3px 10px; border-radius: 15px; font-weight: 600; font-size: 0.85em; }
.mobile-back-btn { background: #f0f0f0; color: #666; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em; margin-bottom: 10px; }
.mobile-back-btn:active { background: #e0e0e0; }
.mobile-list { padding: 10px; }
.mobile-list-item { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer; transition: all 0.2s; }
.mobile-list-item:active { transform: scale(0.98); background: #f8f9fa; }
.mobile-item-title { font-size: 1.1em; font-weight: 700; color: #2c3e50; margin-bottom: 8px; }
.mobile-item-count { color: #2196F3; font-weight: 600; font-size: 0.9em; }
.mobile-item-meta { font-size: 0.85em; color: #999; margin-top: 5px; }
.project-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.card-title { font-size: 1.2em; font-weight: 700; color: #2c3e50; margin-bottom: 12px; }
.card-field { display: flex; margin-bottom: 8px; font-size: 0.9em; }
.card-label { font-weight: 600; color: #666; min-width: 70px; }
.card-value { color: #333; flex: 1; }
.card-actions { display: flex; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e5e5; }
.card-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; text-align: center; display: block; }
.card-btn-primary { background: #2196F3; color: white; }
.card-btn-primary:active { background: #1976D2; }
.card-btn-secondary { background: #f5f5f5; color: #666; }
.card-btn-secondary:active { background: #e0e0e0; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
.modal.active { display: flex; }
.modal-content { background: white; border-radius: 12px; padding: 30px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.modal-header h2 { color: #2c3e50; }
.close-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #999; }
.close-btn:hover { color: #333; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em; font-family: inherit; }
.form-group input[readonly] { background: #f5f5f5; color: #999; }
.form-group select[multiple] { height: 120px; }
.form-group textarea { min-height: 100px; resize: vertical; }
.form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px; }
.btn-primary { background: #2196F3; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
.btn-primary:hover { background: #1976D2; }
.btn-secondary { background: #f0f0f0; color: #666; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
.btn-secondary:hover { background: #e0e0e0; }
.loading { text-align: center; padding: 40px; color: #999; font-size: 1.1em; }
.error { background: #ffebee; border: 1px solid #ef5350; border-radius: 8px; padding: 15px; color: #c62828; margin: 20px 0; }
.error ul { margin: 10px 0 0 20px; }
@media (max-width: 768px) {
  .pc-ui { display: none !important; }
  .mobile-ui { display: block !important; }
  .container { padding: 10px; }
  header { flex-direction: column; gap: 10px; align-items: flex-start; padding: 15px; }
  header h1 { font-size: 1.2em; }
  .header-right { width: 100%; justify-content: space-between; flex-wrap: wrap; }
  .btn { font-size: 0.8em; padding: 8px 12px; }
  .vision-banner { font-size: 1em; padding: 12px; }
  .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .tab { white-space: nowrap; font-size: 0.9em; padding: 10px 15px; }
  .modal-content { padding: 20px; width: 95%; }
}
@media (min-width: 769px) {
  .pc-ui { display: block !important; }
  .mobile-ui { display: none !important; }
}
</style>
</head>
<body>
<div class="container">
<header>
<h1>ğŸš€ HanPass 2026 Dashboard</h1>
<div class="header-right">
<button class="btn" style="display:none;" id="pc-open-all">ğŸ“‚ ì „ì²´ ì—´ê¸°</button>
<button class="btn" style="display:none;" id="pc-close-all">ğŸ“ ì „ì²´ ë‹«ê¸°</button>
<button class="btn" id="refresh-btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
<span class="timestamp" id="timestamp"></span>
</div>
</header>
<div class="vision-banner">ì†ë„ë¡œ ì ì•…í•˜ê³  ê²©ì°¨ë¡œ ëë‚¸ë‹¤</div>
<div class="tabs">
<button class="tab active" data-tab="all">ğŸ“Š ì „ì²´ ë³´ê¸°</button>
<button class="tab" data-tab="updates">ğŸ“ ì—…ë°ì´íŠ¸ ëª¨ì•„ë³´ê¸°</button>
</div>
<div id="all-tab-pc" class="tab-content active pc-ui">
<div class="loading">â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>
<div id="all-tab-mobile" class="tab-content active mobile-ui">
<div class="loading">â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>
<div id="updates-tab" class="tab-content">
<div class="loading">ğŸ“ ì—…ë°ì´íŠ¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>
</div>
<div id="edit-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>í”„ë¡œì íŠ¸ ìˆ˜ì •</h2>
<button class="close-btn" id="modal-close-btn">&times;</button>
</div>
<form id="edit-form">
<input type="hidden" id="edit-project-id">
<div class="form-group">
<label>í”„ë¡œì íŠ¸ëª… (ì½ê¸°ì „ìš©)</label>
<input type="text" id="edit-name" readonly>
</div>
<div class="form-group">
<label>ëª©í‘œ (Goal)</label>
<textarea id="edit-goal"></textarea>
</div>
<div class="form-group">
<label>êµ­ê°€ (ë³µìˆ˜ì„ íƒ - Ctrl/Cmd í´ë¦­)</label>
<select id="edit-country" multiple></select>
<small style="color:#999;">ì—¬ëŸ¬ êµ­ê°€: Ctrl(Win) ë˜ëŠ” Cmd(Mac) + í´ë¦­</small>
</div>
<div class="form-group">
<label>ë¶€ì„œ</label>
<select id="edit-division">
<option value="">ì„ íƒí•˜ì„¸ìš”</option>
</select>
</div>
<div class="form-group">
<label>ë‹´ë‹¹ì (ì½ê¸°ì „ìš©)</label>
<input type="text" id="edit-owner" readonly>
</div>
<div class="form-group">
<label>ìƒíƒœ</label>
<select id="edit-status">
<option value="">ì„ íƒí•˜ì„¸ìš”</option>
</select>
</div>
<div class="form-group">
<label>ì§„í–‰ë„ (%)</label>
<input type="number" id="edit-progress" min="0" max="100">
</div>
<div class="form-group">
<label>ê¸°í•œ</label>
<input type="date" id="edit-deadline">
</div>
<div class="form-actions">
<button type="button" class="btn-secondary" id="modal-cancel-btn">ì·¨ì†Œ</button>
<button type="submit" class="btn-primary">ğŸ’¾ ì €ì¥</button>
</div>
</form>
</div>
</div>
<script>
(function() {
console.log("ğŸš€ HanPass Dashboard v3.0");
var API_URL = "https://hanpass-2026-backend.vercel.app/api";
var allData = { kpis: [], projects: [], schema: {} };
var schema = {};
var isMobile = false;
var mobileState = { level: "kpi", kpiId: null, detailName: null };

function detectDevice() {
  isMobile = window.innerWidth <= 768;
  var pcOpen = document.getElementById("pc-open-all");
  var pcClose = document.getElementById("pc-close-all");
  if (isMobile) {
    pcOpen.style.display = "none";
    pcClose.style.display = "none";
  } else {
    pcOpen.style.display = "inline-block";
    pcClose.style.display = "inline-block";
  }
  console.log("ğŸ“±", isMobile ? "Mobile" : "PC");
}

function updateTimestamp() {
  var now = new Date();
  var h = String(now.getHours()).padStart(2, "0");
  var m = String(now.getMinutes()).padStart(2, "0");
  document.getElementById("timestamp").textContent = "ìµœê·¼: " + h + ":" + m;
}

function switchTab(tabName) {
  console.log("ğŸ“‘ Tab:", tabName);
  var tabs = document.querySelectorAll(".tab");
  var contents = document.querySelectorAll(".tab-content");
  tabs.forEach(function(t) { t.classList.remove("active"); });
  contents.forEach(function(c) { c.classList.remove("active"); });
  
  if (tabName === "all") {
    tabs[0].classList.add("active");
    if (isMobile) {
      document.getElementById("all-tab-mobile").classList.add("active");
    } else {
      document.getElementById("all-tab-pc").classList.add("active");
    }
  } else if (tabName === "updates") {
    tabs[1].classList.add("active");
    document.getElementById("updates-tab").classList.add("active");
    loadUpdates();
  }
}

async function loadData() {
  console.log("ğŸ“¥ Loading...");
  var pc = document.getElementById("all-tab-pc");
  var mob = document.getElementById("all-tab-mobile");
  pc.innerHTML = '<div class="loading">â³ ë¡œë”©ì¤‘...</div>';
  mob.innerHTML = '<div class="loading">â³ ë¡œë”©ì¤‘...</div>';
  
  try {
    var url = API_URL + "?type=all&includeContent=true&_=" + Date.now();
    console.log("ğŸŒ", url);
    var res = await fetch(url, {
      cache: "no-store",
      headers: { "Cache-Control": "no-cache", "Pragma": "no-cache" }
    });
    console.log("ğŸ“¡", res.status);
    if (!res.ok) throw new Error("HTTP " + res.status);
    
    var json = await res.json();
    console.log("âœ… Response:", json);
    if (!json.success || !json.data) throw new Error("Invalid response");
    
    allData = json.data;
    schema = allData.schema || {};
    allData.kpis.sort(function(a, b) { return a.name.localeCompare(b.name, "ko"); });
    allData.projects.sort(function(a, b) { return a.name.localeCompare(b.name, "ko"); });
    console.log("ğŸ“Š", allData.kpis.length, "KPIs,", allData.projects.length, "Projects");
    
    renderPC();
    renderMobileKPIList();
    updateTimestamp();
    console.log("âœ… Done");
  } catch (err) {
    console.error("âŒ", err);
    var html = '<div class="error"><strong>âš ï¸ ë¡œë“œ ì‹¤íŒ¨</strong><br>' + err.message + 
      '<br><br><button class="btn" onclick="location.reload()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button></div>';
    pc.innerHTML = html;
    mob.innerHTML = html;
  }
}

function renderPC() {
  console.log("ğŸ’» PC view");
  var cont = document.getElementById("all-tab-pc");
  var html = "";
  
  allData.kpis.forEach(function(kpi) {
    var projs = allData.projects.filter(function(p) {
      return kpi.projects.some(function(rel) { return rel.id === p.id; });
    });
    console.log("ğŸ“¦", kpi.name, "â†’", projs.length);
    
    var groups = {};
    projs.forEach(function(p) {
      var d = p.kpiDetail || "ê¸°íƒ€";
      if (!groups[d]) groups[d] = [];
      groups[d].push(p);
    });
    var details = Object.keys(groups).sort(function(a, b) { return a.localeCompare(b, "ko"); });
    console.log("ğŸ“Œ Details:", details);
    
    html += '<div class="kpi-group">';
    html += '<div class="kpi-header" data-kpi-id="' + kpi.id + '">';
    html += '<div class="kpi-title">' + kpi.name + '</div>';
    html += '<div style="display:flex;align-items:center;">';
    html += '<div class="kpi-count">' + projs.length + 'ê°œ</div>';
    html += '<div class="kpi-arrow">â–¼</div>';
    html += '</div></div>';
    html += '<div id="kpi-' + kpi.id + '" class="kpi-details">';
    
    details.forEach(function(det) {
      var dProjs = groups[det];
      var dId = "det-" + kpi.id + "-" + det.replace(/[^a-zA-Z0-9ê°€-í£]/g, "");
      console.log("  ğŸ“", det, "â†’", dProjs.length);
      
      html += '<div class="detail-section">';
      html += '<div class="detail-header" data-detail-id="' + dId + '">';
      html += '<div class="detail-left">';
      html += '<span class="detail-pin">ğŸ“Œ</span>';
      html += '<span class="detail-title">' + det + '</span>';
      html += '</div><div style="display:flex;align-items:center;">';
      html += '<span class="detail-count">' + dProjs.length + 'ê°œ</span>';
      html += '<span class="detail-arrow">â–¼</span>';
      html += '</div></div>';
      html += '<div id="' + dId + '" class="detail-content">';
      html += '<div class="table-container"><table><thead><tr>';
      html += '<th>í”„ë¡œì íŠ¸ëª…</th><th>ëª©í‘œ</th><th>êµ­ê°€</th><th>ë¶€ì„œ</th>';
      html += '<th>ë‹´ë‹¹ì</th><th>ìƒíƒœ</th><th>ì§„í–‰ë„</th><th>ê¸°í•œ</th><th>ìˆ˜ì •</th>';
      html += '</tr></thead><tbody>';
      
      dProjs.forEach(function(p) {
        html += '<tr>';
        html += '<td><a href="' + (p.link || "#") + '" target="_blank" class="project-link">' + (p.name || "-") + '</a></td>';
        html += '<td>' + (p.goal || "-") + '</td>';
        html += '<td>' + (p.country || "-") + '</td>';
        html += '<td>' + (p.division || "-") + '</td>';
        html += '<td>' + (p.owner || "-") + '</td>';
        html += '<td>' + (p.status || "-") + '</td>';
        html += '<td>' + (p.progress || 0) + '%</td>';
        html += '<td>' + (p.deadline || "-") + '</td>';
        html += '<td><span class="edit-icon" data-project-id="' + p.id + '">âœï¸</span></td>';
        html += '</tr>';
      });
      
      html += '</tbody></table></div></div></div>';
    });
    
    html += '</div></div>';
  });
  
  cont.innerHTML = html;
  
  // Event listeners
  document.querySelectorAll(".kpi-header").forEach(function(el) {
    el.addEventListener("click", function() {
      var kpiId = el.getAttribute("data-kpi-id");
      document.getElementById("kpi-" + kpiId).classList.toggle("active");
    });
  });
  
  document.querySelectorAll(".detail-header").forEach(function(el) {
    el.addEventListener("click", function() {
      var dId = el.getAttribute("data-detail-id");
      document.getElementById(dId).classList.toggle("active");
    });
  });
  
  document.querySelectorAll(".edit-icon").forEach(function(el) {
    el.addEventListener("click", function() {
      var pid = el.getAttribute("data-project-id");
      openEditModal(pid);
    });
  });
  
  console.log("âœ… PC rendered");
}

function renderMobileKPIList() {
  console.log("ğŸ“± Mobile KPI list");
  mobileState = { level: "kpi", kpiId: null, detailName: null };
  var cont = document.getElementById("all-tab-mobile");
  
  var html = '<div class="mobile-header"><div class="mobile-breadcrumb">';
  html += '<span class="mobile-level-label">ğŸ“Š KPI ëª©ë¡</span>';
  html += '</div></div><div class="mobile-list">';
  
  allData.kpis.forEach(function(kpi) {
    var projs = allData.projects.filter(function(p) {
      return kpi.projects.some(function(rel) { return rel.id === p.id; });
    });
    html += '<div class="mobile-list-item" data-kpi-id="' + kpi.id + '">';
    html += '<div class="mobile-item-title">' + kpi.name + '</div>';
    html += '<div class="mobile-item-count">' + projs.length + 'ê°œ í”„ë¡œì íŠ¸</div>';
    html += '</div>';
  });
  
  html += '</div>';
  cont.innerHTML = html;
  
  // Event
  document.querySelectorAll("#all-tab-mobile .mobile-list-item").forEach(function(el) {
    el.addEventListener("click", function() {
      var kpiId = el.getAttribute("data-kpi-id");
      renderMobileKPIDetails(kpiId);
    });
  });
  
  console.log("âœ… Mobile KPI list");
}

function renderMobileKPIDetails(kpiId) {
  console.log("ğŸ“± KPI details:", kpiId);
  var kpi = allData.kpis.find(function(k) { return k.id === kpiId; });
  if (!kpi) return;
  
  mobileState.level = "detail";
  mobileState.kpiId = kpiId;
  
  var projs = allData.projects.filter(function(p) {
    return kpi.projects.some(function(rel) { return rel.id === p.id; });
  });
  
  var groups = {};
  projs.forEach(function(p) {
    var d = p.kpiDetail || "ê¸°íƒ€";
    if (!groups[d]) groups[d] = [];
    groups[d].push(p);
  });
  var details = Object.keys(groups).sort(function(a, b) { return a.localeCompare(b, "ko"); });
  
  var html = '<div class="mobile-header">';
  html += '<button class="mobile-back-btn" id="mob-back-to-kpi">â¬…ï¸ ë’¤ë¡œ</button>';
  html += '<div class="mobile-breadcrumb">';
  html += '<span class="mobile-level-label">ğŸ“Š KPI</span> â€º ';
  html += '<span class="mobile-level-label">ğŸ“Œ Detail</span>';
  html += '</div><div style="font-weight:700;font-size:1.1em;color:#2c3e50;margin-top:10px;">' + kpi.name + '</div>';
  html += '</div><div class="mobile-list">';
  
  details.forEach(function(det) {
    var dProjs = groups[det];
    html += '<div class="mobile-list-item" data-detail-name="' + det + '">';
    html += '<div class="mobile-item-title">' + det + '</div>';
    html += '<div class="mobile-item-count">' + dProjs.length + 'ê°œ í”„ë¡œì íŠ¸</div>';
    html += '</div>';
  });
  
  html += '</div>';
  document.getElementById("all-tab-mobile").innerHTML = html;
  
  // Event
  document.getElementById("mob-back-to-kpi").addEventListener("click", renderMobileKPIList);
  
  document.querySelectorAll("#all-tab-mobile .mobile-list-item").forEach(function(el) {
    el.addEventListener("click", function() {
      var detName = el.getAttribute("data-detail-name");
      renderMobileProjects(kpiId, detName);
    });
  });
  
  console.log("âœ… Mobile details");
}

function renderMobileProjects(kpiId, detName) {
  console.log("ğŸ“± Projects:", kpiId, detName);
  var kpi = allData.kpis.find(function(k) { return k.id === kpiId; });
  if (!kpi) return;
  
  mobileState.level = "project";
  mobileState.detailName = detName;
  
  var projs = allData.projects.filter(function(p) {
    return kpi.projects.some(function(rel) { return rel.id === p.id; }) && 
           (p.kpiDetail || "ê¸°íƒ€") === detName;
  });
  
  var html = '<div class="mobile-header">';
  html += '<button class="mobile-back-btn" id="mob-back-to-detail">â¬…ï¸ ë’¤ë¡œ</button>';
  html += '<div class="mobile-breadcrumb">';
  html += '<span class="mobile-level-label">ğŸ“Š KPI</span> â€º ';
  html += '<span class="mobile-level-label">ğŸ“Œ Detail</span> â€º ';
  html += '<span class="mobile-level-label">ğŸ“„ í”„ë¡œì íŠ¸</span>';
  html += '</div><div style="font-weight:700;font-size:1.1em;color:#2c3e50;margin-top:10px;">' + kpi.name + ' â€º ' + detName + '</div>';
  html += '</div><div class="mobile-list">';
  
  projs.forEach(function(p) {
    html += '<div class="project-card">';
    html += '<div class="card-title">' + p.name + '</div>';
    html += '<div class="card-field"><span class="card-label">ëª©í‘œ:</span><span class="card-value">' + (p.goal || "-") + '</span></div>';
    html += '<div class="card-field"><span class="card-label">êµ­ê°€:</span><span class="card-value">' + (p.country || "-") + '</span></div>';
    html += '<div class="card-field"><span class="card-label">ë¶€ì„œ:</span><span class="card-value">' + (p.division || "-") + '</span></div>';
    html += '<div class="card-field"><span class="card-label">ë‹´ë‹¹ì:</span><span class="card-value">' + (p.owner || "-") + '</span></div>';
    html += '<div class="card-field"><span class="card-label">ìƒíƒœ:</span><span class="card-value">' + (p.status || "-") + '</span></div>';
    html += '<div class="card-field"><span class="card-label">ì§„í–‰ë„:</span><span class="card-value">' + (p.progress || 0) + '%</span></div>';
    html += '<div class="card-field"><span class="card-label">ê¸°í•œ:</span><span class="card-value">' + (p.deadline || "-") + '</span></div>';
    html += '<div class="card-actions">';
    html += '<button class="card-btn card-btn-secondary" data-project-id="' + p.id + '">âœï¸ ìˆ˜ì •</button>';
    html += '<a href="' + (p.link || "#") + '" target="_blank" class="card-btn card-btn-primary">ğŸ”— ë…¸ì…˜</a>';
    html += '</div></div>';
  });
  
  html += '</div>';
  document.getElementById("all-tab-mobile").innerHTML = html;
  
  // Event
  document.getElementById("mob-back-to-detail").addEventListener("click", function() {
    renderMobileKPIDetails(kpiId);
  });
  
  document.querySelectorAll(".card-btn-secondary").forEach(function(el) {
    el.addEventListener("click", function() {
      var pid = el.getAttribute("data-project-id");
      openEditModal(pid);
    });
  });
  
  console.log("âœ… Mobile projects");
}

function toggleAllKpis(open) {
  document.querySelectorAll(".kpi-details").forEach(function(el) {
    if (open) el.classList.add("active");
    else el.classList.remove("active");
  });
  document.querySelectorAll(".detail-content").forEach(function(el) {
    if (open) el.classList.add("active");
    else el.classList.remove("active");
  });
}

function loadUpdates() {
  console.log("ğŸ“ Updates");
  var cont = document.getElementById("updates-tab");
  var projs = allData.projects;
  
  if (!projs || projs.length === 0) {
    cont.innerHTML = '<div class="loading">âš ï¸ í”„ë¡œì íŠ¸ ì—†ìŒ</div>';
    return;
  }
  
  function isRecent(time) {
    if (!time) return false;
    var now = new Date();
    var ed = new Date(time);
    var days = (now - ed) / (1000 * 60 * 60 * 24);
    return days <= 7;
  }
  
  function timeAgo(time) {
    var now = new Date();
    var past = new Date(time);
    var diff = now - past;
    var mins = Math.floor(diff / (1000 * 60));
    var hours = Math.floor(diff / (1000 * 60 * 60));
    var days = Math.floor(diff / (1000 * 60 * 60 * 24));
    if (mins < 60) return mins + "ë¶„ ì „";
    if (hours < 24) return hours + "ì‹œê°„ ì „";
    return days + "ì¼ ì „";
  }
  
  var recent = projs.filter(function(p) {
    return isRecent(p.lastEditedTime) && p.content && p.content.trim();
  }).sort(function(a, b) {
    return new Date(b.lastEditedTime) - new Date(a.lastEditedTime);
  });
  
  console.log("ğŸ“Š Recent:", recent.length);
  
  if (recent.length === 0) {
    cont.innerHTML = '<div class="loading">ğŸ“­ ìµœê·¼ 7ì¼ ì—…ë°ì´íŠ¸ ì—†ìŒ</div>';
    return;
  }
  
  var html = '<div class="update-list" style="background:white;border-radius:12px;padding:20px;">';
  recent.forEach(function(p) {
    var ago = timeAgo(p.lastEditedTime);
    html += '<div style="border-bottom:1px solid #e5e5e5;padding:20px 0;">';
    html += '<h3 style="color:#333;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;font-size:1.1em;">';
    html += p.name + '<span style="font-size:0.85em;color:#999;font-weight:normal;">' + ago + '</span>';
    html += '</h3><div style="margin-top:12px;padding-top:12px;font-size:0.95em;color:#666;">';
    html += '<p><strong>ëª©í‘œ:</strong> ' + (p.goal || "-") + '</p>';
    html += '<p><strong>ìƒíƒœ:</strong> ' + (p.status || "-") + ' | <strong>ì§„í–‰ë„:</strong> ' + (p.progress || 0) + '%</p>';
    html += '<div style="margin-top:10px;padding:10px;background:#f8f9fa;border-radius:6px;font-size:0.9em;white-space:pre-wrap;">';
    html += p.content;
    html += '</div><a href="' + (p.link || "#") + '" target="_blank" style="display:inline-block;margin-top:10px;color:#2196F3;text-decoration:none;font-weight:600;font-size:0.9em;">ğŸ”— ë…¸ì…˜ â†’</a>';
    html += '</div></div>';
  });
  html += '</div>';
  cont.innerHTML = html;
  console.log("âœ… Updates");
}

function openEditModal(pid) {
  console.log("âœï¸ Edit:", pid);
  var p = allData.projects.find(function(x) { return x.id === pid; });
  if (!p) {
    alert("í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  console.log("ğŸ“¦", p);
  document.getElementById("edit-project-id").value = p.id;
  document.getElementById("edit-name").value = p.name || "";
  document.getElementById("edit-goal").value = p.goal || "";
  document.getElementById("edit-owner").value = p.owner || "";
  document.getElementById("edit-progress").value = p.progress || 0;
  document.getElementById("edit-deadline").value = p.deadline || "";
  
  var countrySel = document.getElementById("edit-country");
  countrySel.innerHTML = "";
  if (schema.countries && schema.countries.length > 0) {
    schema.countries.forEach(function(c) {
      var opt = document.createElement("option");
      opt.value = c.name;
      opt.textContent = c.name;
      if (p.countryArray && p.countryArray.indexOf(c.name) >= 0) {
        opt.selected = true;
      }
      countrySel.appendChild(opt);
    });
    console.log("âœ… Countries:", countrySel.options.length);
  } else {
    console.warn("âš ï¸ No countries");
  }
  
  var divSel = document.getElementById("edit-division");
  divSel.innerHTML = '<option value="">ì„ íƒ</option>';
  if (schema.divisions && schema.divisions.length > 0) {
    schema.divisions.forEach(function(d) {
      var opt = document.createElement("option");
      opt.value = d.name;
      opt.textContent = d.name;
      if (p.division === d.name) opt.selected = true;
      divSel.appendChild(opt);
    });
    console.log("âœ… Divisions:", divSel.options.length);
  }
  
  var staSel = document.getElementById("edit-status");
  staSel.innerHTML = '<option value="">ì„ íƒ</option>';
  if (schema.statuses && schema.statuses.length > 0) {
    schema.statuses.forEach(function(s) {
      var opt = document.createElement("option");
      opt.value = s.name;
      opt.textContent = s.name;
      if (p.status === s.name) opt.selected = true;
      staSel.appendChild(opt);
    });
    console.log("âœ… Statuses:", staSel.options.length);
  }
  
  document.getElementById("edit-modal").classList.add("active");
  console.log("âœ… Modal open");
}

function closeEditModal() {
  document.getElementById("edit-modal").classList.remove("active");
}

async function handleEditSubmit(e) {
  e.preventDefault();
  console.log("ğŸ’¾ Submit");
  
  var pid = document.getElementById("edit-project-id").value;
  var goal = document.getElementById("edit-goal").value;
  var countrySel = document.getElementById("edit-country").selectedOptions;
  var country = Array.from(countrySel).map(function(opt) { return opt.value; });
  var div = document.getElementById("edit-division").value;
  var sta = document.getElementById("edit-status").value;
  var prog = parseInt(document.getElementById("edit-progress").value) || 0;
  var dead = document.getElementById("edit-deadline").value;
  
  var payload = {
    projectId: pid,
    goal: goal,
    country: country,
    division: div,
    status: sta,
    progress: prog,
    deadline: dead
  };
  console.log("ğŸ“¤", payload);
  
  try {
    var res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    var result = await res.json();
    console.log("ğŸ“¥", result);
    
    if (result.success) {
      alert("âœ… ì €ì¥ ì™„ë£Œ!");
      closeEditModal();
      loadData();
    } else {
      alert("âŒ ì‹¤íŒ¨: " + (result.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
    }
  } catch (err) {
    console.error("âŒ", err);
    alert("âŒ ì˜¤ë¥˜: " + err.message);
  }
}

// Global event listeners
document.getElementById("pc-open-all").addEventListener("click", function() { toggleAllKpis(true); });
document.getElementById("pc-close-all").addEventListener("click", function() { toggleAllKpis(false); });
document.getElementById("refresh-btn").addEventListener("click", loadData);

document.querySelectorAll(".tab").forEach(function(tab) {
  tab.addEventListener("click", function() {
    var tabName = tab.getAttribute("data-tab");
    switchTab(tabName);
  });
});

document.getElementById("modal-close-btn").addEventListener("click", closeEditModal);
document.getElementById("modal-cancel-btn").addEventListener("click", closeEditModal);
document.getElementById("edit-form").addEventListener("submit", handleEditSubmit);

document.getElementById("edit-modal").addEventListener("click", function(e) {
  if (e.target === this) closeEditModal();
});

window.addEventListener("resize", detectDevice);

// Init
console.log("ğŸ¬ Init");
detectDevice();
loadData();
})();
</script>
</body>
</html>
