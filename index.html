<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HanPass 2026 Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Malgun Gothic', sans-serif;
      background: #ffffff;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid #e5e5e5;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 1.5em;
      font-weight: 700;
      color: #333;
    }

    .header-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .timestamp {
      color: #999;
      font-size: 0.9em;
    }

    .vision-banner {
      background: #f8f9fa;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 15px 20px;
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.1em;
      font-weight: 600;
      color: #555;
    }

    .btn {
      padding: 8px 16px;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      background: white;
      color: #555;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .btn:hover {
      background: #f5f5f5;
      border-color: #2196F3;
    }

    .btn.active {
      background: #2196F3;
      color: white;
      border-color: #2196F3;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e5e5;
      padding-bottom: 0;
    }

    .tab {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: #666;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: -2px;
    }

    .tab:hover {
      color: #2196F3;
    }

    .tab.active {
      color: #2196F3;
      border-bottom-color: #2196F3;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .kpi-group {
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .kpi-header {
      background: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 1px solid #e5e5e5;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .kpi-header:hover {
      background: #f0f0f0;
    }

    .kpi-header h2 {
      font-size: 1.1em;
      font-weight: 600;
      color: #333;
    }

    .kpi-header .count {
      color: #999;
      font-size: 0.9em;
    }

    .kpi-details {
      display: none;
    }

    .kpi-details.active {
      display: block;
    }

    .detail-section {
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
    }

    .detail-section:last-child {
      border-bottom: none;
    }

    .detail-section h3 {
      font-size: 1em;
      font-weight: 600;
      color: #555;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .detail-section h3 .pin {
      color: #ff5252;
      font-size: 0.9em;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 6px;
      border: 1px solid #e5e5e5;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      font-size: 0.9em;
    }

    th {
      background: #f8f9fa;
      color: #555;
      font-weight: 600;
      text-align: left;
      padding: 12px;
      border-bottom: 2px solid #e5e5e5;
      white-space: nowrap;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      color: #333;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover {
      background: #fafafa;
    }

    /* ë³€ê²½ í•„ë“œ - í…ìŠ¤íŠ¸ë§Œ ìƒ‰ìƒ ë³€ê²½ */
    .changed-value {
      color: #1976d2;
      font-weight: 600;
    }

    .edit-icon {
      cursor: pointer;
      color: #2196F3;
      font-size: 1.1em;
      transition: color 0.2s;
    }

    .edit-icon:hover {
      color: #1976d2;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-content h2 {
      margin-bottom: 25px;
      color: #333;
      font-size: 1.4em;
    }

    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: #555;
      font-size: 0.9em;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      font-size: 0.95em;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #2196F3;
    }

    .form-group input:disabled {
      background: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
    }

    .btn-primary {
      background: #2196F3;
      color: white;
      border: 1px solid #2196F3;
    }

    .btn-primary:hover {
      background: #1976d2;
      border-color: #1976d2;
    }

    .btn-secondary {
      background: white;
      color: #555;
      border: 1px solid #d0d0d0;
    }

    .btn-secondary:hover {
      background: #f5f5f5;
    }

    .update-list {
      display: grid;
      gap: 15px;
    }

    .update-card {
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 20px;
      border-left: 4px solid #2196F3;
    }

    .update-card h3 {
      color: #333;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.1em;
    }

    .update-time {
      font-size: 0.85em;
      color: #999;
      font-weight: normal;
    }

    .update-content {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f0f0f0;
      font-size: 0.95em;
      color: #666;
    }

    .notion-link {
      display: inline-block;
      margin-top: 10px;
      color: #2196F3;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9em;
    }

    .notion-link:hover {
      text-decoration: underline;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .error {
      background: #ffebee;
      border: 1px solid #ef5350;
      border-radius: 8px;
      padding: 15px;
      color: #c62828;
      margin: 20px 0;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }

      header h1 {
        font-size: 1.2em;
      }

      .header-right {
        width: 100%;
        justify-content: space-between;
      }

      .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .tab {
        white-space: nowrap;
        font-size: 0.9em;
        padding: 10px 15px;
      }

      .table-container {
        overflow-x: scroll;
      }

      table {
        font-size: 0.8em;
      }

      th, td {
        padding: 8px;
      }

      .modal-content {
        padding: 20px;
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸš€ HanPass 2026 Dashboard</h1>
      <div class="header-right">
        <button class="btn" onclick="toggleAllKpis(true)">ğŸ“‚ ì „ì²´ ì—´ê¸°</button>
        <button class="btn" onclick="toggleAllKpis(false)">ğŸ“ ì „ì²´ ë‹«ê¸°</button>
        <button class="btn" onclick="loadData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <span class="timestamp" id="timestamp"></span>
      </div>
    </header>

    <div class="vision-banner">
      ì†ë„ë¡œ ì¥ì•…í•˜ê³  ê²©ì°¨ë¡œ ëë‚¸ë‹¤
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('all')">ğŸ“Š ì „ì²´ ë³´ê¸°</button>
      <button class="tab" onclick="switchTab('updates')">ğŸ“ ì—…ë°ì´íŠ¸ ëª¨ì•„ë³´ê¸°</button>
    </div>

    <div id="all-tab" class="tab-content active"></div>
    <div id="updates-tab" class="tab-content"></div>
  </div>

  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <h2>âœï¸ í”„ë¡œì íŠ¸ ìˆ˜ì •</h2>
      <form id="edit-form">
        <input type="hidden" id="edit-project-id">
        
        <div class="form-group">
          <label>í”„ë¡œì íŠ¸ëª… (ì½ê¸° ì „ìš©)</label>
          <input type="text" id="edit-name" disabled>
        </div>

        <div class="form-group">
          <label>ëª©í‘œ</label>
          <textarea id="edit-goal" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label>êµ­ê°€</label>
          <select id="edit-country" multiple size="5"></select>
        </div>

        <div class="form-group">
          <label>ë¶€ì„œ</label>
          <select id="edit-division"></select>
        </div>

        <div class="form-group">
          <label>ë‹´ë‹¹ì (ì½ê¸° ì „ìš©)</label>
          <input type="text" id="edit-owner" disabled>
        </div>

        <div class="form-group">
          <label>ìƒíƒœ</label>
          <select id="edit-status"></select>
        </div>

        <div class="form-group">
          <label>ì§„í–‰ë¥  (%)</label>
          <input type="number" id="edit-progress" min="0" max="100">
        </div>

        <div class="form-group">
          <label>ë§ˆê°ì¼</label>
          <input type="date" id="edit-deadline">
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeEditModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = 'https://hanpass-2026-backend.vercel.app/api';
    let allData = {};
    let previousData = {};
    let schema = {};

    function updateTimestamp() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('ko-KR');
      document.getElementById('timestamp').textContent = `ë§ˆì§€ë§‰ ë™ê¸°í™”: ì˜¤ëŠ˜ ${timeStr}`;
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      if (tabName === 'all') {
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('all-tab').classList.add('active');
      } else if (tabName === 'updates') {
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('updates-tab').classList.add('active');
        loadUpdates();
      }
    }

    async function loadData() {
      const container = document.getElementById('all-tab');
      container.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

      try {
        console.log('ğŸ”„ API í˜¸ì¶œ:', `${API_URL}?type=all&includeContent=true`);
        
        const response = await fetch(`${API_URL}?type=all&includeContent=true`, {
          cache: 'no-store',
          headers: { 'Cache-Control': 'no-cache' }
        });

        console.log('ğŸ“¡ ì‘ë‹µ ìƒíƒœ:', response.status);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const apiResponse = await response.json();
        console.log('âœ… API ì‘ë‹µ:', apiResponse);
        
        if (!apiResponse.success) {
          throw new Error(apiResponse.error || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }

        const data = apiResponse.data;
        
        if (!data.kpis || !data.projects) {
          throw new Error('ë°ì´í„° êµ¬ì¡° ì˜¤ë¥˜: kpis ë˜ëŠ” projectsê°€ ì—†ìŠµë‹ˆë‹¤');
        }

        console.log(`âœ… KPIs: ${data.kpis.length}ê°œ, Projects: ${data.projects.length}ê°œ`);
        console.log(`âœ… Schema:`, data.schema);

        // ìŠ¤í‚¤ë§ˆ ì €ì¥
        schema = data.schema || {};

        // ì´ì „ ë°ì´í„° ë¡œë“œ
        const savedData = localStorage.getItem('previousData');
        if (savedData) {
          previousData = JSON.parse(savedData);
        }

        allData = data;
        localStorage.setItem('previousData', JSON.stringify(data));

        renderAllView(data);
        updateTimestamp();
      } catch (error) {
        console.error('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = `
          <div class="error">
            <strong>ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</strong><br>
            ${error.message}<br><br>
            <button class="btn" onclick="loadData()">ë‹¤ì‹œ ì‹œë„</button>
          </div>
        `;
      }
    }

    function isWithin7Days(lastEditedTime) {
      if (!lastEditedTime) return false;
      const now = new Date();
      const edited = new Date(lastEditedTime);
      const diffDays = (now - edited) / (1000 * 60 * 60 * 24);
      return diffDays <= 7;
    }

    function hasChanged(projectId, field, currentValue) {
      if (!previousData.projects) return false;
      
      const prevProject = previousData.projects.find(p => p.id === projectId);
      if (!prevProject) return false;

      const project = allData.projects.find(p => p.id === projectId);
      if (!project || !isWithin7Days(project.lastEditedTime)) return false;

      return prevProject[field] !== currentValue;
    }

    function getTimeAgo(dateString) {
      const now = new Date();
      const past = new Date(dateString);
      const diffMs = now - past;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
      if (diffHours < 24) return `${diffHours}ì‹œê°„ ì „`;
      return `${diffDays}ì¼ ì „`;
    }

    function renderAllView(data) {
      const container = document.getElementById('all-tab');
      const { kpis, projects } = data;

      const grouped = {};
      kpis.forEach(kpi => {
        grouped[kpi.id] = { ...kpi, details: {} };
      });

      const assignedProjects = new Set();
      kpis.forEach(kpi => {
        if (kpi.projects && Array.isArray(kpi.projects)) {
          kpi.projects.forEach(proj => {
            const projectId = typeof proj === 'string' ? proj : proj.id;
            const project = projects.find(p => p.id === projectId);
            if (project) {
              const detailName = project.kpiDetail || 'ë¯¸ë¶„ë¥˜';
              if (!grouped[kpi.id].details[detailName]) {
                grouped[kpi.id].details[detailName] = [];
              }
              grouped[kpi.id].details[detailName].push(project);
              assignedProjects.add(project.id);
            }
          });
        }
      });

      projects.forEach(project => {
        if (assignedProjects.has(project.id)) return;
        
        if (project.kpi) {
          const kpi = kpis.find(k => k.id === project.kpi);
          if (kpi) {
            const detailName = project.kpiDetail || 'ë¯¸ë¶„ë¥˜';
            if (!grouped[kpi.id].details[detailName]) {
              grouped[kpi.id].details[detailName] = [];
            }
            grouped[kpi.id].details[detailName].push(project);
            assignedProjects.add(project.id);
            console.log(`âœ… Fallback: ${project.name} â†’ ${kpi.name}`);
          }
        }
      });

      const unassigned = projects.filter(p => !assignedProjects.has(p.id));
      if (unassigned.length > 0) {
        grouped['unassigned'] = {
          id: 'unassigned',
          name: 'ë¯¸ë¶„ë¥˜',
          details: { 'ë¯¸ë¶„ë¥˜': unassigned }
        };
      }

      const sortedKpis = Object.values(grouped).sort((a, b) => {
        const aMatch = a.name.match(/^([A-Z])\.(.+)/);
        const bMatch = b.name.match(/^([A-Z])\.(.+)/);
        
        if (aMatch && bMatch) {
          return aMatch[1].localeCompare(bMatch[1]);
        }
        return a.name.localeCompare(b.name, 'ko');
      });

      let html = '';
      sortedKpis.forEach(kpi => {
        const totalProjects = Object.values(kpi.details).reduce((sum, arr) => sum + arr.length, 0);
        
        html += `
          <div class="kpi-group">
            <div class="kpi-header" onclick="toggleKpi('${kpi.id}')">
              <h2>${kpi.name}</h2>
              <span class="count">${totalProjects}ê°œ í”„ë¡œì íŠ¸</span>
            </div>
            <div id="kpi-${kpi.id}" class="kpi-details">
        `;

        Object.entries(kpi.details).forEach(([detailName, detailProjects]) => {
          html += `
            <div class="detail-section">
              <h3>
                <span class="pin">ğŸ“</span>
                ${detailName} 
                <span style="color: #999; font-weight: normal; font-size: 0.9em;">${detailProjects.length}ê°œ</span>
              </h3>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th style="width: 20%">í”„ë¡œì íŠ¸ëª…</th>
                      <th style="width: 15%">ëª©í‘œ</th>
                      <th style="width: 10%">êµ­ê°€</th>
                      <th style="width: 8%">ë¶€ì„œ</th>
                      <th style="width: 8%">ë‹´ë‹¹ì</th>
                      <th style="width: 8%">ìƒíƒœ</th>
                      <th style="width: 8%">ì§„í–‰ë¥ </th>
                      <th style="width: 10%">ë§ˆê°ì¼</th>
                      <th style="width: 5%">ìˆ˜ì •</th>
                    </tr>
                  </thead>
                  <tbody>
          `;

          detailProjects.forEach(project => {
            const goalClass = hasChanged(project.id, 'goal', project.goal) ? 'changed-value' : '';
            const countryClass = hasChanged(project.id, 'country', project.country) ? 'changed-value' : '';
            const divisionClass = hasChanged(project.id, 'division', project.division) ? 'changed-value' : '';
            const statusClass = hasChanged(project.id, 'status', project.status) ? 'changed-value' : '';
            const progressClass = hasChanged(project.id, 'progress', project.progress) ? 'changed-value' : '';
            const deadlineClass = hasChanged(project.id, 'deadline', project.deadline) ? 'changed-value' : '';

            html += `
              <tr>
                <td>${project.name || '-'}</td>
                <td><span class="${goalClass}">${project.goal || '-'}</span></td>
                <td><span class="${countryClass}">${project.country || '-'}</span></td>
                <td><span class="${divisionClass}">${project.division || '-'}</span></td>
                <td>${project.owner || '-'}</td>
                <td><span class="${statusClass}">${project.status || '-'}</span></td>
                <td><span class="${progressClass}">${project.progress || 0}%</span></td>
                <td><span class="${deadlineClass}">${project.deadline || '-'}</span></td>
                <td><span class="edit-icon" onclick="openEditModal('${project.id}')">âœï¸</span></td>
              </tr>
            `;
          });

          html += `
                  </tbody>
                </table>
              </div>
            </div>
          `;
        });

        html += `
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function toggleKpi(kpiId) {
      const element = document.getElementById(`kpi-${kpiId}`);
      element.classList.toggle('active');
    }

    function toggleAllKpis(open) {
      document.querySelectorAll('.kpi-details').forEach(el => {
        if (open) {
          el.classList.add('active');
        } else {
          el.classList.remove('active');
        }
      });
    }

    async function loadUpdates() {
      const container = document.getElementById('updates-tab');
      const { projects } = allData;

      if (!projects) {
        container.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”</div>';
        return;
      }

      // 7ì¼ ì´ë‚´ ì—…ë°ì´íŠ¸ + ë©”ëª¨ê°€ ìˆëŠ” í”„ë¡œì íŠ¸ë§Œ
      const recentProjects = projects
        .filter(p => isWithin7Days(p.lastEditedTime) && p.content && p.content.trim() !== '')
        .sort((a, b) => new Date(b.lastEditedTime) - new Date(a.lastEditedTime));

      console.log(`ğŸ“ ì—…ë°ì´íŠ¸ ëª¨ì•„ë³´ê¸°: 7ì¼ ì´ë‚´ ${projects.filter(p => isWithin7Days(p.lastEditedTime)).length}ê°œ, ë©”ëª¨ ìˆìŒ ${recentProjects.length}ê°œ`);

      if (recentProjects.length === 0) {
        container.innerHTML = '<div class="loading">ìµœê·¼ 7ì¼ ì´ë‚´ ë©”ëª¨ê°€ ì—…ë°ì´íŠ¸ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      let html = '<div class="update-list">';

      recentProjects.forEach(project => {
        const timeAgo = getTimeAgo(project.lastEditedTime);
        
        html += `
          <div class="update-card">
            <h3>
              ${project.name}
              <span class="update-time">${timeAgo}</span>
            </h3>
            <div class="update-content">
              <p><strong>ëª©í‘œ:</strong> ${project.goal || '-'}</p>
              <p><strong>ìƒíƒœ:</strong> ${project.status || '-'} | <strong>ì§„í–‰ë¥ :</strong> ${project.progress || 0}%</p>
              <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.9em; white-space: pre-wrap;">${project.content}</div>
              <a href="${project.link || '#'}" target="_blank" class="notion-link">ë…¸ì…˜ì—ì„œ ì „ì²´ ë³´ê¸° â†’</a>
            </div>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
    }

    function openEditModal(projectId) {
      const project = allData.projects.find(p => p.id === projectId);
      if (!project) return;

      document.getElementById('edit-project-id').value = project.id;
      document.getElementById('edit-name').value = project.name || '';
      document.getElementById('edit-goal').value = project.goal || '';
      document.getElementById('edit-owner').value = project.owner || '';
      document.getElementById('edit-progress').value = project.progress || 0;
      document.getElementById('edit-deadline').value = project.deadline || '';

      // ë…¸ì…˜ ìŠ¤í‚¤ë§ˆì—ì„œ ì˜µì…˜ ë¡œë“œ
      const countrySelect = document.getElementById('edit-country');
      countrySelect.innerHTML = '';
      if (schema.countries && schema.countries.length > 0) {
        schema.countries.forEach(country => {
          const option = document.createElement('option');
          option.value = country.name;
          option.textContent = country.name;
          // í˜„ì¬ ì„ íƒëœ êµ­ê°€ ì²´í¬
          const selectedCountries = (project.country || '').split(',').map(c => c.trim());
          if (selectedCountries.includes(country.name)) {
            option.selected = true;
          }
          countrySelect.appendChild(option);
        });
      }

      const divisionSelect = document.getElementById('edit-division');
      divisionSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
      if (schema.divisions && schema.divisions.length > 0) {
        schema.divisions.forEach(division => {
          const option = document.createElement('option');
          option.value = division.name;
          option.textContent = division.name;
          if (project.division === division.name) {
            option.selected = true;
          }
          divisionSelect.appendChild(option);
        });
      }

      const statusSelect = document.getElementById('edit-status');
      statusSelect.innerHTML = '';
      if (schema.statuses && schema.statuses.length > 0) {
        schema.statuses.forEach(status => {
          const option = document.createElement('option');
          option.value = status.name;
          option.textContent = status.name;
          if (project.status === status.name) {
            option.selected = true;
          }
          statusSelect.appendChild(option);
        });
      }

      document.getElementById('edit-modal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('edit-modal').classList.remove('active');
    }

    document.getElementById('edit-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const projectId = document.getElementById('edit-project-id').value;
      const goal = document.getElementById('edit-goal').value;
      const countryOptions = document.getElementById('edit-country').selectedOptions;
      const country = Array.from(countryOptions).map(o => o.value).join(', ');
      const division = document.getElementById('edit-division').value;
      const status = document.getElementById('edit-status').value;
      const progress = parseInt(document.getElementById('edit-progress').value);
      const deadline = document.getElementById('edit-deadline').value;

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            projectId,
            goal,
            country,
            division,
            status,
            progress,
            deadline
          })
        });

        const result = await response.json();
        
        if (result.success) {
          alert('í”„ë¡œì íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
          closeEditModal();
          loadData();
        } else {
          alert('ìˆ˜ì • ì‹¤íŒ¨: ' + result.error);
        }
      } catch (error) {
        console.error('ìˆ˜ì • ì‹¤íŒ¨:', error);
        alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    });

    document.getElementById('edit-modal').addEventListener('click', (e) => {
      if (e.target.id === 'edit-modal') {
        closeEditModal();
      }
    });

    loadData();
  </script>
</body>
</html>
